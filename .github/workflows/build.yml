name: Build SoftEther VPN Client (OpenWrt 24.10.2, static)

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          wget \
          xz-utils \
          file

    - name: Download OpenWrt SDK (24.10.2, RPi4)
      run: |
        wget https://archive.openwrt.org/releases/24.10.2/targets/bcm27xx/bcm2711/openwrt-sdk-24.10.2-bcm27xx-bcm2711_gcc-13.3.0_musl.Linux-x86_64.tar.zst
        tar xf openwrt-sdk-24.10.2-bcm27xx-bcm2711_gcc-13.3.0_musl.Linux-x86_64.tar.zst
        
    - name: Download SoftEther VPN Client
      run: |
        wget https://github.com/SoftEtherVPN/SoftEtherVPN_Stable/releases/download/v4.44-9807-rtm/softether-vpnclient-v4.44-9807-rtm-2025.04.16-linux-arm64-64bit.tar.gz
        tar xf softether-vpnclient-v4.44-9807-rtm-2025.04.16-linux-arm64-64bit.tar.gz

    - name: Build static SoftEther binaries
      run: |
        SDK=$(pwd)/openwrt-sdk-24.10.2-bcm27xx-bcm2711_gcc-13.3.0_musl.Linux-x86_64
        TOOLCHAIN=$SDK/staging_dir/toolchain-aarch64_cortex-a72_gcc-13.3.0_musl

        export PATH=$TOOLCHAIN/bin:$PATH
        export CC=aarch64-openwrt-linux-musl-gcc
        export AR=aarch64-openwrt-linux-musl-ar
        export RANLIB=aarch64-openwrt-linux-musl-ranlib

        # Enforce full static
        export CFLAGS="-O2 -fPIE -static -fstack-protector-strong -D_FORTIFY_SOURCE=2"
        export LDFLAGS="-static -pie -Wl,-z,now -Wl,-z,relro"

        cd vpnclient
        test -f Makefile || { echo "Makefile not found"; exit 1; }
        make clean || true
        make CC=$CC main

    - name: Verify binaries
      run: |
        file softether/vpnclient
        file softether/vpncmd

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: softether-openwrt-static
        path: |
          softether/vpnclient
          softether/vpncmd
