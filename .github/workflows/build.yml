name: Build SoftEther VPN Client (OpenWrt 24.10, dynamic, ARM64)

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install host dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          wget \
          git \
          xz-utils \
          file \
          patch

    - name: Download OpenWrt SDK (24.10.2, RPi4)
      run: |
        wget https://archive.openwrt.org/releases/24.10.2/targets/bcm27xx/bcm2711/openwrt-sdk-24.10.2-bcm27xx-bcm2711_gcc-13.3.0_musl.Linux-x86_64.tar.zst
        tar xf openwrt-sdk-24.10.2-bcm27xx-bcm2711_gcc-13.3.0_musl.Linux-x86_64.tar.zst

    - name: Clone SoftEther source
      run: |
        git clone --depth=1 https://github.com/SoftEtherVPN/SoftEtherVPN_Stable.git
        cd SoftEtherVPN_Stable
        git submodule update --init --recursive

    - name: Apply musl compatibility patch
      run: |
        cd SoftEtherVPN_Stable

        cat << 'EOF' > src/Mayaqua/MuslCompat.h
        #pragma once
        #ifdef __linux__
        #ifdef __MUSL__
        #define open64      open
        #define creat64     creat
        #define fopen64     fopen
        #define lseek64     lseek
        #define statfs64    statfs
        #define scandir64   scandir
        #define alphasort64 alphasort
        #define getrlimit64 getrlimit
        #define setrlimit64 setrlimit
        #define __strdup    strdup
        #include <string.h>
        #include <stddef.h>
        static inline void *__rawmemchr(const void *s, int c) {
            return memchr(s, c, (size_t)-1);
        }
        #define __rawmemchr __rawmemchr
        #endif
        #endif
        EOF

        # Inject header into Mayaqua
        sed -i '1i #include "MuslCompat.h"' src/Mayaqua/Mayaqua.h

    - name: Build SoftEther VPN Client (dynamic)
      run: |
        SDK=$(pwd)/openwrt-sdk-24.10.2-bcm27xx-bcm2711_gcc-13.3.0_musl.Linux-x86_64
        TOOLCHAIN=$SDK/staging_dir/toolchain-aarch64_cortex-a72_gcc-13.3.0_musl

        export PATH=$TOOLCHAIN/bin:$PATH
        export STAGING_DIR=$SDK/staging_dir
        export CC=aarch64-openwrt-linux-musl-gcc
        export AR=aarch64-openwrt-linux-musl-ar
        export RANLIB=aarch64-openwrt-linux-musl-ranlib

        export CFLAGS="-O2 -fPIC --sysroot=$STAGING_DIR/target-aarch64_cortex-a72_musl"
        export LDFLAGS="--sysroot=$STAGING_DIR/target-aarch64_cortex-a72_musl"

        cd SoftEtherVPN_Stable

        # SoftEther build system
        ./configure
        make

    - name: Collect binaries
      run: |
        mkdir -p artifacts
        find SoftEtherVPN_Stable -type f -name vpnclient -exec cp {} artifacts/ \;
        find SoftEtherVPN_Stable -type f -name vpncmd -exec cp {} artifacts/ \;

    - name: Verify binaries
      run: |
        file artifacts/vpnclient
        file artifacts/vpncmd

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: softether-openwrt-dynamic
        path: artifacts/*
